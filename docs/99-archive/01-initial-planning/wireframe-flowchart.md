# 와이어프레임 & 플로우차트 (시나리오/기획 단계)

## 1. 시스템 개요

### 1.1 핵심 사용자 시나리오

**시나리오 1: 주문 및 배송**
- 업체 담당자가 다른 업체로 상품 주문
- 시스템이 자동으로 배송 경로 생성
- 담당자들에게 알림 발송

**시나리오 2: 배송 추적**
- 배송 담당자가 배송 상태 업데이트
- 실시간 배송 현황 조회

**시나리오 3: 허브 관리**
- 관리자가 허브/경로 관리
- 배송 담당자 배정

---

## 2. 사용자 여정 맵 (User Journey Map)

### 2.1 업체 담당자 (COMPANY_MANAGER)

```
[가입] → [승인 대기] → [로그인] → [주문 생성] → [배송 조회] → [완료 확인]
  ↓         ↓            ↓           ↓            ↓             ↓
 입력     대기중      인증완료    상품선택    실시간추적      수령확인
```

**상세 단계**:

1. **회원가입**
   - username, password, 이름, slack_id 입력
   - 소속 업체명 입력
   - status: PENDING

2. **승인 대기**
   - 관리자 승인 대기
   - status: APPROVED 되면 로그인 가능

3. **주문 생성**
   - 공급업체 선택
   - 상품 선택 (재고 확인)
   - 수량 입력
   - 납품 기한 입력
   - 주문 확정

4. **배송 조회**
   - 내 주문 목록 조회
   - 배송 상태 확인
   - 예상 도착 시간 확인

5. **수령 확인**
   - 배송 완료 알림 수신
   - 수령 확인

### 2.2 배송 담당자 (DELIVERY_MANAGER)

#### 2.2.1 허브 배송 담당자

```
[로그인] → [배송 목록 조회] → [배송 시작] → [허브 이동] → [도착 처리] → [완료]
   ↓            ↓                ↓            ↓            ↓           ↓
  인증      담당 배송 확인      출발처리    이동중처리    도착처리    다음배송
```

#### 2.2.2 업체 배송 담당자

```
[로그인] → [당일 경로 확인] → [배송 시작] → [업체 방문] → [수령 확인] → [완료]
   ↓           ↓                 ↓            ↓            ↓           ↓
  인증      경로최적화         출발처리      현장배송     서명받기    다음방문
```

### 2.3 허브 관리자 (HUB_MANAGER)

```
[로그인] → [대시보드] → [업체 관리] → [담당자 관리] → [주문 모니터링]
   ↓          ↓           ↓             ↓               ↓
  인증     현황파악    CRUD작업      배정관리        실시간추적
```

### 2.4 마스터 관리자 (MASTER)

```
[로그인] → [전체 대시보드] → [허브 관리] → [경로 관리] → [승인 관리] → [시스템 설정]
   ↓           ↓              ↓            ↓            ↓              ↓
  인증      전체현황       CRUD작업     경로최적화    사용자승인      설정변경
```

---

## 3. 핵심 비즈니스 플로우차트

### 3.1 주문 생성 및 배송 생성 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                       주문 생성 프로세스                          │
└─────────────────────────────────────────────────────────────────┘

[업체 담당자]
     │
     │ 1. 주문 요청
     ↓
[order-service]
     │
     │ 2. 공급업체 검증
     ↓
[company-service] ─────→ 존재하지 않음 ─────→ [오류 반환]
     │                                              ↓
     │ 존재함                                   [종료]
     ↓
[order-service]
     │
     │ 3. 수령업체 검증
     ↓
[company-service] ─────→ 존재하지 않음 ─────→ [오류 반환]
     │                                              ↓
     │ 존재함                                   [종료]
     ↓
[order-service]
     │
     │ 4. 상품 및 재고 검증
     ↓
[product-service] ─────→ 재고 부족 ─────→ [오류 반환]
     │                                         ↓
     │ 재고 충분                            [종료]
     ↓
     │ 5. 재고 차감
     ↓
[order-service]
     │
     │ 6. 주문 레코드 생성 (status: PENDING)
     ↓
     │ 7. 배송 생성 요청
     ↓
[delivery-service]
     │
     │ 8. 출발/도착 허브 조회
     ↓
[hub-service]
     │
     │ 9. 허브 간 경로 조회
     ↓
     │ 10. 경로 리스트 반환
     ↓
[delivery-service]
     │
     ├─ 11. delivery 레코드 생성 (status: HUB_WAITING)
     │
     ├─ 12. 각 구간별 delivery_routes 생성
     │      - 허브 배송 담당자 순차 배정 (round-robin)
     │      - sequence: 1, 2, 3...
     │
     └─ 13. 업체 배송 담당자 배정 (목적지 허브 소속)
     │
     │ 14. delivery_id 반환
     ↓
[order-service]
     │
     │ 15. order.delivery_id 업데이트
     │     order.status = CONFIRMED
     ↓
     │ 16. Slack 알림 요청 (Gemini AI 포함)
     ↓
[slack-service]
     │
     │ 17. Gemini AI 호출
     │     - 상품 정보, 납품 기한
     │     - 경로 정보 (출발-경유-도착)
     │     - 근무 시간 (09:00-18:00)
     │
     ↓
     │ 18. AI 응답: 최종 발송 시한 계산
     ↓
     │ 19. Slack 메시지 생성 및 발송
     │     - 수신자: 출발 허브 관리자
     │     - 내용: 주문 정보 + 발송 시한
     ↓
     │ 20. slack_messages 레코드 저장
     ↓
[order-service]
     │
     │ 21. 주문 완료 응답
     ↓
[업체 담당자]
     │
     │ 22. 주문 확인
     ↓
   [완료]
```

### 3.2 배송 경로 상태 업데이트 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                    배송 상태 업데이트 프로세스                     │
└─────────────────────────────────────────────────────────────────┘

[허브 배송 담당자]
     │
     │ 1. 배송 시작 (구간 1)
     ↓
[delivery-service]
     │
     ├─ 2. delivery_routes[seq=1].status = IN_PROGRESS
     ├─ 3. delivery_routes[seq=1].started_at = NOW()
     └─ 4. deliveries.status = HUB_MOVING
     │
     │ ... 이동 중 ...
     ↓
[허브 배송 담당자]
     │
     │ 5. 도착 처리 (구간 1)
     ↓
[delivery-service]
     │
     ├─ 6. delivery_routes[seq=1].status = COMPLETED
     ├─ 7. delivery_routes[seq=1].completed_at = NOW()
     ├─ 8. delivery_routes[seq=1].actual_distance_km = X
     └─ 9. delivery_routes[seq=1].actual_duration_minutes = Y
     │
     │ 10. 다음 구간 있는지 확인
     ↓
     │ [구간 2 존재]
     ↓
[다음 허브 배송 담당자]
     │
     │ 11. 배송 시작 (구간 2)
     ↓
     ... (반복) ...
     │
     │ [모든 허브 구간 완료]
     ↓
[delivery-service]
     │
     │ 12. deliveries.status = HUB_ARRIVED
     ↓
[업체 배송 담당자]
     │
     │ 13. 업체 배송 시작
     ↓
[delivery-service]
     │
     │ 14. deliveries.status = COMPANY_MOVING
     │     deliveries.started_at = NOW()
     ↓
     │ ... 업체 방문 ...
     ↓
[업체 배송 담당자]
     │
     │ 15. 수령 확인
     ↓
[delivery-service]
     │
     │ 16. deliveries.status = COMPLETED
     │     deliveries.completed_at = NOW()
     ↓
[order-service]
     │
     │ 17. orders.order_status = COMPLETED
     ↓
   [완료]
```

### 3.3 사용자 등록 및 승인 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                       사용자 등록 프로세스                         │
└─────────────────────────────────────────────────────────────────┘

[사용자]
     │
     │ 1. 회원가입 요청
     │    - username (4-10자)
     │    - password (8-15자)
     │    - name
     │    - slack_id
     │    - 소속 업체/허브명
     ↓
[auth-service]
     │
     │ 2. 입력 검증
     ├─→ username 형식 확인
     ├─→ password 복잡도 확인
     └─→ 중복 체크
     │
     │ 검증 실패 ────→ [오류 반환] → [종료]
     │
     │ 검증 성공
     ↓
     │ 3. 비밀번호 암호화 (BCrypt)
     ↓
     │ 4. 사용자 레코드 생성
     │    - status: PENDING
     │    - role: 입력값
     ↓
     │ 5. 가입 완료 응답
     ↓
[사용자]
     │
     │ 6. 승인 대기 안내
     ↓
   [대기]


┌─────────────────────────────────────────────────────────────────┐
│                       승인/거절 프로세스                          │
└─────────────────────────────────────────────────────────────────┘

[MASTER/HUB_MANAGER]
     │
     │ 1. 승인 요청 목록 조회
     │    - WHERE status = PENDING
     ↓
[auth-service]
     │
     │ 2. PENDING 사용자 목록 반환
     ↓
[MASTER/HUB_MANAGER]
     │
     │ 3. 사용자 검토
     ├─→ [승인] ────→ 4a. status = APPROVED
     │                      ↓
     │                  5a. 사용자 로그인 가능
     │
     └─→ [거절] ────→ 4b. status = REJECTED
                           ↓
                       5b. 사용자 로그인 불가
```

### 3.4 일일 배송 경로 최적화 플로우 (도전 과제)

```
┌─────────────────────────────────────────────────────────────────┐
│                  일일 배송 경로 최적화 프로세스                    │
└─────────────────────────────────────────────────────────────────┘

[스케줄러] - 매일 06:00
     │
     │ 1. 당일 배송 목록 조회
     ↓
[delivery-service]
     │
     │ 2. 허브별 업체 배송 목록 그룹화
     │    - WHERE delivery_status = HUB_ARRIVED
     │    - GROUP BY destination_hub_id
     ↓
     │ 3. 각 허브별 처리
     ↓
     ├─ 4. 배송지 주소 목록 추출
     │      - 각 업체의 위도/경도
     │
     ├─ 5. Gemini AI 호출
     │      - 입력: 출발지(허브), 배송지 목록
     │      - 요청: 최적 방문 순서 계산
     │
     ├─ 6. AI 응답: 최적 순서 리스트
     │      - [업체1, 업체3, 업체2, 업체4...]
     │
     ├─ 7. Naver Maps API 호출
     │      - 출발지: 허브 위경도
     │      - waypoints: AI 순서대로 업체 위경도
     │      - 도착지: 마지막 업체
     │
     ├─ 8. 경로 API 응답
     │      - 총 거리, 총 시간
     │      - 구간별 거리, 시간
     │
     ├─ 9. company_delivery_routes 레코드 생성
     │      - delivery_sequence = AI 순서
     │      - expected_distance/duration = API 결과
     │
     └─ 10. Slack 메시지 생성
           - 수신자: 해당 허브 업체 배송 담당자
           - 내용: 최적 경로 + 예상 시간
     │
     │ 11. Slack 발송
     ↓
[업체 배송 담당자]
     │
     │ 12. 경로 확인
     ↓
   [배송 시작]
```

---

## 4. 데이터 상태 전이 다이어그램

### 4.1 주문 상태 (order_status)

```
[PENDING] ──확정──→ [CONFIRMED] ──배송시작──→ [IN_DELIVERY] ──완료──→ [COMPLETED]
    │                    │
    │                    │
    └──────취소──────────┴─────────→ [CANCELLED]
```

### 4.2 배송 상태 (delivery_status)

```
[HUB_WAITING] ──출발──→ [HUB_MOVING] ──허브도착──→ [HUB_ARRIVED]
                                                        │
                                                   업체배송시작
                                                        ↓
                                              [COMPANY_MOVING]
                                                        │
                                                     수령완료
                                                        ↓
                                                  [COMPLETED]
```

### 4.3 배송 경로 상태 (route_status)

```
[WAITING] ──배송시작──→ [IN_PROGRESS] ──도착처리──→ [COMPLETED]
```

### 4.4 사용자 상태 (status)

```
[PENDING] ──승인──→ [APPROVED] (로그인 가능)
    │
    └──거절──→ [REJECTED] (로그인 불가)
```

---

## 5. 시스템 컨텍스트 다이어그램

```
┌────────────────────────────────────────────────────────────────┐
│                           외부 환경                             │
└────────────────────────────────────────────────────────────────┘

     [사용자]                                    [Slack API]
         │                                            ↑
         │ HTTP Request                               │ Webhook/API
         ↓                                            │
    ┌─────────────────────────────────────────────────┐
    │                                                 │
    │              14logis 시스템                     │
    │                                                 │
    │  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
    │  │ Gateway  │→ │ Services │→ │PostgreSQL│    │
    │  └──────────┘  └──────────┘  └──────────┘    │
    │                                                 │
    └─────────────────────────────────────────────────┘
                        │
                        │ API Request
                        ↓
                  [Gemini AI API]
```

---

## 6. 서비스 간 통신 시퀀스

### 6.1 주문 생성 시퀀스

```
[Client] → [Gateway] → [Auth] : JWT 검증
                         ↓
              [Order Service] : 주문 생성 요청
                         │
                         ├→ [Company Service] : 공급업체 조회
                         ├→ [Company Service] : 수령업체 조회
                         ├→ [Product Service] : 상품 & 재고 확인
                         ├→ [Product Service] : 재고 차감
                         │
                         ├→ [Delivery Service] : 배송 생성
                         │         │
                         │         ├→ [Hub Service] : 허브 조회
                         │         ├→ [Hub Service] : 경로 조회
                         │         └→ [Auth Service] : 담당자 조회
                         │
                         └→ [Slack Service] : 알림 요청
                                   │
                                   ├→ [Gemini AI] : 발송 시한 계산
                                   └→ [Slack API] : 메시지 발송
```

### 6.2 배송 상태 업데이트 시퀀스

```
[Delivery Personnel] → [Gateway] → [Auth] : JWT 검증
                                      ↓
                         [Delivery Service] : 상태 업데이트
                                      │
                                      ├→ delivery_routes 업데이트
                                      ├→ deliveries 업데이트
                                      │
                                      └→ [Order Service] : 주문 상태 동기화
```

---

## 7. 화면 와이어프레임 (간단 스케치)

### 7.1 주문 생성 화면

```
┌─────────────────────────────────────────────────────┐
│  주문 생성                                      [X]  │
├─────────────────────────────────────────────────────┤
│                                                     │
│  공급 업체: [드롭다운 선택      ▼]                  │
│                                                     │
│  수령 업체: [드롭다운 선택      ▼]                  │
│                                                     │
│  상품 선택: [드롭다운 선택      ▼]                  │
│             (재고: 100개 가능)                      │
│                                                     │
│  주문 수량: [________] 개                           │
│                                                     │
│  납품 기한: [2025-11-01] [15:00]                    │
│                                                     │
│  요청 사항: ┌────────────────────────────────────┐  │
│            │                                    │  │
│            │                                    │  │
│            └────────────────────────────────────┘  │
│                                                     │
│                     [취소]  [주문 생성]             │
└─────────────────────────────────────────────────────┘
```

### 7.2 배송 추적 화면

```
┌─────────────────────────────────────────────────────┐
│  주문 #12345 - 배송 추적                        [X]  │
├─────────────────────────────────────────────────────┤
│                                                     │
│  주문 정보                                          │
│  - 공급업체: 건조식품 가공업체 (경기 북부)          │
│  - 수령업체: 수산물 도매업체 (부산)                 │
│  - 상품: 마른오징어 50박스                          │
│  - 주문일시: 2025-10-31 10:00                       │
│                                                     │
│  배송 현황                                          │
│  ┌────────────────────────────────────────────┐   │
│  │  ● 경기 북부 센터 출발      (완료)          │   │
│  │  │                                          │   │
│  │  ● 대전 센터 도착/출발      (완료)          │   │
│  │  │                                          │   │
│  │  ◐ 대구 센터 이동 중        (진행중)        │   │
│  │  │                                          │   │
│  │  ○ 부산 센터 도착 예정                      │   │
│  │  │                                          │   │
│  │  ○ 수산물 도매업체 배송 예정                │   │
│  └────────────────────────────────────────────┘   │
│                                                     │
│  예상 도착: 2025-11-01 14:30                        │
│                                                     │
│                              [새로고침] [닫기]      │
└─────────────────────────────────────────────────────┘
```

### 7.3 배송 담당자 - 배송 목록 화면

```
┌─────────────────────────────────────────────────────┐
│  내 배송 목록 - 김배송 담당자               [로그아웃]│
├─────────────────────────────────────────────────────┤
│                                                     │
│  오늘 배송: 3건                                     │
│                                                     │
│  ┌───────────────────────────────────────────┐     │
│  │ 배송 #1                         [시작하기] │     │
│  │ 경기 북부 → 대전                           │     │
│  │ 마른오징어 50박스                          │     │
│  │ 상태: 대기중                               │     │
│  └───────────────────────────────────────────┘     │
│                                                     │
│  ┌───────────────────────────────────────────┐     │
│  │ 배송 #2                         [시작하기] │     │
│  │ 대전 → 대구                                │     │
│  │ 플라스틱 부품 100개                        │     │
│  │ 상태: 대기중                               │     │
│  └───────────────────────────────────────────┘     │
│                                                     │
│  ┌───────────────────────────────────────────┐     │
│  │ 배송 #3                         [도착처리] │     │
│  │ 서울 → 경기 북부                           │     │
│  │ 전자제품 20박스                            │     │
│  │ 상태: 이동중 (출발 09:30)                  │     │
│  └───────────────────────────────────────────┘     │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 8. 다음 단계

이 와이어프레임과 플로우차트를 바탕으로:

1. **ERD 설계** - 데이터 구조 구체화
2. **API 명세서** - 엔드포인트 정의
3. **인프라 설계도** - 시스템 아키텍처 시각화

현재는 **시나리오/기획 단계** 완료.
